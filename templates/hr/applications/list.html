{% extends "base.html" %}
{% load static %}

{% block hide_sidebar %}true{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/applications_list.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">

    <h1>Applications</h1>

    <!-- =========================
         FILTER BAR (GET ONLY)
    ========================== -->
    <div class="apps-filter-bar">
        <form method="GET" class="apps-filter-form">

            <!-- Search -->
            <input type="text"
                   name="search"
                   placeholder="Search candidate..."
                   value="{{ search }}"
                   class="apps-input">

            <button type="submit" class="btn btn-primary apps-btn">
                Search
            </button>

            <!-- Status Filter -->
            <select name="status" class="apps-select">
                <option value="">All Status</option>
                <option value="screening" {% if status_filter == "screening" %}selected{% endif %}>Screening</option>
                <option value="review" {% if status_filter == "review" %}selected{% endif %}>Review</option>
                <option value="interview" {% if status_filter == "interview" %}selected{% endif %}>Interview</option>
                <option value="hired" {% if status_filter == "hired" %}selected{% endif %}>Hired</option>
                <option value="rejected" {% if status_filter == "rejected" %}selected{% endif %}>Rejected</option>
            </select>

        </form>
    </div>

    <!-- =========================
         APPLICATIONS TABLE
    ========================== -->
    <table class="table mt-3">
        <thead>
            <tr>
                <th>Candidate</th>
                <th>Email</th>
                <th>Job</th>
                <th>Status</th>
                <th>Applied On</th>
            </tr>
        </thead>

        <tbody>
        {% for app in apps_page %}
            <tr>

                <!-- Candidate -->
                <td data-label="Candidate">
                    <a href="{% url 'hr_application_detail' app.id %}" class="table-link">
                        {{ app.full_name }}
                    </a>
                </td>

                <!-- Email -->
                <td data-label="Email">{{ app.email }}</td>   

                <!-- Job -->
                <td data-label="Job">{{ app.job.title }}</td>

                <!-- STATUS UPDATE (AJAX) -->
                <td data-label="Status">
                    <select class="apps-select status-select"
                            data-app-id="{{ app.id }}">
                        <option value="screening" {% if app.status == "screening" %}selected{% endif %}>Screening</option>
                        <option value="review" {% if app.status == "review" %}selected{% endif %}>Review</option>
                        <option value="interview" {% if app.status == "interview" %}selected{% endif %}>Interview</option>
                        <option value="hired" {% if app.status == "hired" %}selected{% endif %}>Hired</option>
                        <option value="rejected" {% if app.status == "rejected" %}selected{% endif %}>Rejected</option>
                    </select>
                </td>

                <!-- Applied Date -->
                <td data-label="Applied On">
                    {{ app.applied_at|date:"d M Y, h:i A" }}
                </td>

            </tr>
        {% empty %}
            <tr>
                <td colspan="5" class="table-empty">
                    No applications found.
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- =========================
         PAGINATION
    ========================== -->
    {% if is_paginated %}
    <div class="pagination-controls mt-3">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}"
               class="btn btn-outline">Previous</a>
        {% endif %}

        <span class="page-info">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}"
               class="btn btn-outline">Next</a>
        {% endif %}
    </div>
    {% endif %}

</div>

<!-- =========================
     STATUS UPDATE SCRIPT
========================== -->
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie("csrftoken");

document.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", function () {

        const appId = this.dataset.appId;
        const newStatus = this.value;

        fetch(`/applications/hr/${appId}/status/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
                status: newStatus
            })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert("Failed to update status");
            }
        })
        .catch(() => {
            alert("Network error");
        });
    });
});
</script>

{% endblock %}
