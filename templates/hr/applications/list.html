{% extends "base.html" %}
{% load static %}

{% block hide_sidebar %}true{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/applications_list.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">

    <h1>Applications</h1>

    <!-- =========================
         FILTER BAR (GET ONLY)
    ========================== -->
    <div class="apps-filter-bar">
        <form method="GET" class="apps-filter-form">

            <!-- Search -->
            <input type="text"
                   name="search"
                   placeholder="Search candidate..."
                   value="{{ search }}"
                   class="apps-input">

            <button type="submit" class="btn btn-primary apps-btn">
                Search
            </button>

            <!-- Status Filter -->
            <select name="status" class="apps-select">
                <option value="">All Status</option>
                <option value="screening" {% if status_filter == "screening" %}selected{% endif %}>Screening</option>
                <option value="review" {% if status_filter == "review" %}selected{% endif %}>Review</option>
                <option value="interview" {% if status_filter == "interview" %}selected{% endif %}>Interview</option>
                <option value="hired" {% if status_filter == "hired" %}selected{% endif %}>Hired</option>
                <option value="rejected" {% if status_filter == "rejected" %}selected{% endif %}>Rejected</option>
            </select>

        </form>
    </div>

    <!-- =========================
         APPLICATIONS TABLE
    ========================== -->
    <table class="table mt-3">
        <thead>
            <tr>
                <th>Candidate</th>
                <th>Email</th>
                <th>Job</th>
                <th>Status</th>
                <th>Applied On</th>
            </tr>
        </thead>

        <tbody>
        {% for app in apps_page %}
            <tr>

                <!-- Candidate -->
                <td data-label="Candidate">
                    <a href="{% url 'hr_application_detail' app.id %}" class="table-link">
                        {{ app.full_name }}
                    </a>
                </td>

                <!-- Email -->
                <td data-label="Email">{{ app.email }}</td>   

                <!-- Job -->
                <td data-label="Job">{{ app.job.title }}</td>

                <!-- STATUS UPDATE (AJAX) -->
   <td data-label="Status">
    <form method="POST"
          action="{% url 'hr_status_update' app.id %}"
          class="status-form">

        {% csrf_token %}

        <input type="hidden"
               name="status"
               value="{{ app.status }}"
               class="hidden-status">

        <select class="apps-select status-select"
                data-current="{{ app.status }}">
            <option value="screening" {% if app.status == "screening" %}selected{% endif %}>Screening</option>
            <option value="review" {% if app.status == "review" %}selected{% endif %}>Review</option>
            <option value="interview" {% if app.status == "interview" %}selected{% endif %}>Interview</option>
            <option value="hired" {% if app.status == "hired" %}selected{% endif %}>Hired</option>
            <option value="rejected" {% if app.status == "rejected" %}selected{% endif %}>Rejected</option>
        </select>

    </form>
</td>

                <!-- Applied Date -->
                <td data-label="Applied On">
                    {{ app.applied_at|date:"d M Y, h:i A" }}
                </td>

            </tr>
        {% empty %}
            <tr>
                <td colspan="5" class="table-empty">
                    No applications found.
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- =========================
         PAGINATION
    ========================== -->
    {% if is_paginated %}
    <div class="pagination-controls mt-3">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}"
               class="btn btn-outline">Previous</a>
        {% endif %}

        <span class="page-info">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}"
               class="btn btn-outline">Next</a>
        {% endif %}
    </div>
    {% endif %}

</div>

<div id="statusModal" class="logout-popup" style="display:none;">
    <div class="logout-box">
        <p>Are you sure you want to update status?</p>

        <div class="logout-actions">
            <button id="statusConfirm" class="btn btn-primary">Confirm</button>
            <button id="statusCancel" class="btn btn-outline">Cancel</button>
        </div>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const modal = document.getElementById("statusModal");
    const confirmBtn = document.getElementById("statusConfirm");
    const cancelBtn = document.getElementById("statusCancel");

    let activeForm = null;
    let activeSelect = null;
    let originalValue = null;

    document.querySelectorAll(".status-select").forEach(select => {

        select.addEventListener("change", function () {

            activeForm = this.closest("form");
            activeSelect = this;
            originalValue = this.dataset.current;

            modal.style.display = "flex";
        });

    });

    confirmBtn.addEventListener("click", function () {

        const hiddenInput = activeForm.querySelector(".hidden-status");
        hiddenInput.value = activeSelect.value;

        modal.style.display = "none";
        activeForm.submit();
    });

    cancelBtn.addEventListener("click", function () {

        modal.style.display = "none";
        activeSelect.value = originalValue;
    });

});
</script>
{% endblock %}
